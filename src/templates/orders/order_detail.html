{% extends "base.html" %}

{% block title %}
  –ó–∞–∫–∞–∑ ‚Ññ{{ order.pk }}
{% endblock %}

{% block content %}
  <section class="mx-auto max-w-5xl">
    <div class="grid grid-cols-12 gap-5">
      <div class="col-span-8 flex flex-col">
        <!-- MARK: –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–∫–∞–∑–∞ -->
        <div class="border border-gray-100 p-4 mb-4">
          <h1 class="text-3xl font-semibold mb-4">–ó–∞–∫–∞–∑ ‚Ññ{{ order.pk }}</h1>

          {% if messages %}
            {% for message in messages %}
              {% if message.extra_tags == 'warning' %}
                {% include "alert.html" with message=message style="warning" %}
              {% else %}
                {% include "alert.html" with message=message style="success" %}
              {% endif %}
            {% endfor %}
          {% endif %}

          <h2 class="text-xl font-medium mb-2">{{ order.item.title }}</h2>

          <div class="mb-1">
            {% if user == order.customer %}
              –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:
              <a href="{% url 'users:public_profile' order.provider.username %}" class="hover:underline">{{ order.provider.username }}</a>
            {% else %}
              –ó–∞–∫–∞–∑—á–∏–∫: {{ order.item.customer.username }}
              <a href="{% url 'users:public_profile' order.customer.username %}" class="hover:underline">{{ order.customer.username }}</a>
            {% endif %}
          </div>
          <div class="mb-1">
            C–æ–∑–¥–∞–Ω: {{ order.created }}
          </div>
          <div class="mb-1">
            –ë—é–¥–∂–µ—Ç: {{ order.price }} ‚ÇΩ
          </div>
          <div class="mb-8">
            –°—Ç–∞—Ç—É—Å: {{ order.get_status_display }}
          </div>
          <div>
            {{ order.item.description|linebreaksbr }}
          </div>
        </div>

        <!-- MARK: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π –ø–æ –∑–∞–∫–∞–∑—É -->
        <div class="border border-gray-100 p-4 mb-4">
          <h2 class="text-xl font-medium mb-2">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π –ø–æ –∑–∞–∫–∞–∑—É</h2>

          {% for action in actions %}
            <div>{{ action.user }} {{ action.verb }} <span class="text-gray-500 text-sm">&middot; {{ action.created }}</span></div>
          {% endfor %}
        </div>

        <!-- MARK: –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="border border-gray-100 p-4 mb-4">
          <h2 class="text-xl font-medium mb-2">–°–æ–æ–±—â–µ–Ω–∏—è</h2>

          {% if chat_messages.count %}
            <div class="flex flex-col mb-4">
              {% for message in chat_messages %}
                <div class="p-4 flex flex-col" id="message_{{ message.pk }}">
                  <div class="text-sm">{{ message.sender.username }} –ø–∏—à–µ—Ç <span class="text-gray-500">&middot; {{ message.created }}</span></div>
                  <div>{{ message.text }}</div>
                  {% if message.file %}
                    <div class="text-sm text-gray-500">–§–∞–π–ª: <a href="{{ message.file.url }}" class="hover:underline">{{ message.file.name }}</a></div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% endif %}

          <form action="{% url 'exchange:message_create' %}" method="POST" enctype="multipart/form-data" class="mb-2">
            {% csrf_token %}
            <input type="hidden" name="topic_ct" value="Order">
            <input type="hidden" name="topic_id" value="{{ order.pk }}">
            {% if user == order.customer %}
              <input type="hidden" name="recipient_id" value={{ order.provider.pk }}>
            {% else %}
              <input type="hidden" name="recipient_id" value={{ order.customer.pk }}>
            {% endif %}
            <textarea name="text" required cols="40" rows="5" minlength="3" maxlength="1500" class="mb-2 textarea px-4 py-2 text-gray-700 bg-white focus:outline-none w-full border appearance-none block leading-normal rounded-lg border-gray-300"></textarea>
            <div class="flex items-center">
              <div class="flex-1">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å: <input type="file" name="file" accept="*/*"></div>
              <button class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
          </form>
          {% include "alert.html" with message="–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª –∫ –≤–∞—à–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é." style="info" %}
        </div>
      </div>

      <div class="col-span-4 flex flex-col">
          <div class="border border-gray-100 p-4 flex flex-col mb-4">
            <h2 class="text-xl font-medium mb-2">
              {% if user == order.customer %}
                –í—ã ‚Äì –∑–∞–∫–∞–∑—á–∏–∫
              {% else %}
                –í—ã ‚Äì –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
              {% endif %}
            </h2>

            {% if order.is_completed %}
              <p>–£—Ä–∞! üéâ –ó–∞–∫–∞–∑ –±—ã–ª —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω.</p>
            {% endif %}

            {% if user == order.customer %}
              <!-- MARK: –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∑–∞–∫–∞–∑—á–∏–∫–∞ -->
              {% if order.status == 'created' %}
                {# –ü–æ–∫–∞ –∑–∞–∫–∞–∑ –Ω–µ –ø—Ä–∏–Ω—è—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º, –∑–∞–∫–∞–∑—á–∏–∫ –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å –µ–≥–æ. #}
                <form action="{% url 'orders:set_status' order.pk %}" method="POST">
                  {% csrf_token %}
                  <input type="hidden" name="new_status" value="cancelled_by_customer">
                  <button class="w-full text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑</button>
                </form>
              {% elif order.status == 'in_progress' %}
                <p>–í–∞—à –∑–∞–∫–∞–∑ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–±–æ—Ç–µ. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –Ω–∞–ø—Ä–∞–≤–∏—Ç –µ–≥–æ –≤–∞–º –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ –º–µ—Ä–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏.</p>
              {% elif order.status == 'submitted_by_provider' %}
                {# –†–∞—Å—Å–º–æ—Ç—Ä–µ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–±–æ—Ç—ã –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è, –∑–∞–∫–∞–∑—á–∏–∫ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å —Ä–∞–±–æ—Ç—É –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É #}
                <p class="mb-2 text-sm">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –Ω–∞–ø—Ä–∞–≤–∏–ª –≤–∞–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –∑–∞–∫–∞–∑ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É. –ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ —Ä–∞–±–æ—Ç—É —Ç–æ–ª—å–∫–æ –≤ —Ç–æ–º —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –∑–∞–¥–∞—á–∏, –∏–ª–∏ –≤–µ—Ä–Ω–∏—Ç–µ –∑–∞–∫–∞–∑ –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É.</p>
                <form action="{% url 'orders:set_status' order.pk %}" method="POST">
                  {% csrf_token %}
                  <input type="hidden" name="new_status" value="accepted_by_customer">
                  <button class="mb-1 w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">–ü—Ä–∏–Ω—è—Ç—å —Ä–∞–±–æ—Ç—É</button>
                </form>
                <form action="{% url 'orders:set_status' order.pk %}" method="POST">
                  {% csrf_token %}
                  <input type="hidden" name="new_status" value="returned_by_customer">
                  <button class="w-full text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">–í–µ—Ä–Ω—É—Ç—å –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É</button>
                </form>
              {% elif order.status == 'returned_by_customer' %}
                <p class="text-sm">–í—ã –≤–µ—Ä–Ω—É–ª–∏ –∑–∞–∫–∞–∑ –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—é. –î–æ–∂–∏–¥–∞–π—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã.</p>
              {% endif %}
            {% else %}
              <!-- MARK: –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è -->
              {% if order.status == 'created' %}
                {# –ü–æ–∫–∞ –∑–∞–∫–∞–∑ —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–Ω, –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–∏–Ω—è—Ç—å –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –µ–≥–æ. #}
                <form action="{% url 'orders:set_status' order.pk %}" method="POST">
                  {% csrf_token %}
                  <input type="hidden" name="new_status" value="in_progress">
                  <button class="mb-1 w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</button>
                </form>
                <form action="{% url 'orders:set_status' order.pk %}" method="POST">
                  {% csrf_token %}
                  <input type="hidden" name="new_status" value="rejected_by_provider">
                  <button class="w-full text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–∫–∞–∑</button>
                </form>
              {% elif order.status == 'in_progress' or order.status == 'returned_by_customer' %}
                {# –ó–∞–∫–∞–∑ –≤ —Ä–∞–±–æ—Ç–µ/–≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—ã–π –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç "—Å–¥–∞—Ç—å" –ø–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏: #}
                <p class="mb-2 text-sm">–°–¥–∞–≤–∞–π—Ç–µ –∑–∞–∫–∞–∑, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏.</p>
                <form action="{% url 'orders:set_status' order.pk %}" method="POST">
                  {% csrf_token %}
                  <input type="hidden" name="new_status" value="submitted_by_provider">
                  <button class="mb-1 w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">–°–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
                </form>
              {% elif order.status == 'submitted_by_provider' %}
                <p class="text-sm">–í—ã –Ω–∞–ø—Ä–∞–≤–∏–ª–∏ —Ä–∞–±–æ—Ç—É –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∑–∞–∫–∞–∑—á–∏–∫—É. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –∏–ª–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É.</p>
              {% endif %}
            {% endif %}
          </div>
      </div>
    </div>
  </section>
{% endblock content %}